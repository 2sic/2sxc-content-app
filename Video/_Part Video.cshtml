@inherits Custom.Hybrid.Razor12
@using ToSic.Razor.Blade;
@using System.Text.RegularExpressions;
@*
  this is a partial template which is re-used in _Video.cshtml. 
  It will show the video preview and link-to-lightbox of the Content item
*@

@{
  // Check if the link is a youtube, and convert that to a youtube embed
	var youTubeLink = Regex.Match(Content.VideoLink, @"youtu(?:\.be|be\.com)/(?:.*v(?:/|=)|(?:.*/)?)([a-zA-Z0-9-_]+)");
  var youTubeUrl = youTubeLink.Success
    ? "https://www.youtube.com/embed/" + youTubeLink.Groups[1].Value + "?controls=1&fs=1&modestbranding=0&rel=0&showinfo=0&autohide=1&iv_load_policy=3&theme=dark&wmode=transparent&autoplay=true"
    : "";

  // configuration
  var quality = Settings.ImageHighResOn ? Settings.ImageHighResQuality : Settings.ImageQuality;
  var lightboxQuality = Settings.LightboxImageHighResOn ? Settings.LightboxImageHighResQuality : Settings.LightboxImageQuality;

  // this is the parameter passed in from the calling page
  int width = (int)Settings.ImageWidth * (Settings.ImageHighResOn ? 2 : 1);
  int height = (int)Settings.ImageWidth * 9/16 * (Settings.ImageHighResOn ? 2 : 1);
}
@if(Content.Presentation.VideoLightbox != false) {
  // open in lightbox
  <a data-fancybox="fancybox-@CmsContext.Module.Id" class="co-video" data-width="1280" data-height="720" data-caption="@Content.Title" href="@youTubeUrl">
      @if(Text.Has(Content.Image)) {
      <figure>
        <div class="overlay d-flex justify-content-center align-items-center w-100 h-100">
          <i class="fab fa-youtube"></i>
        </div>
        <img class="img-fluid"
          src='@Tags.SafeUrl(Content.Image + "?w=" + width + "&h=" + height + "&mode=crop&scale=both&quality=" + quality)'
          alt="@Content.Title" />
      </figure>
      } else {
        <div class="dnnFormMessage dnnFormWarning">Preview Image not found. Please add Preview Image or turn off Video-Lightbox</div>
      }
  </a>
} else {
  // no lightbox, show directly
  <div class="co-video-embed embed-responsive embed-responsive-16by9">
    @if(youTubeLink.Success) {
      <img src="https://img.youtube.com/vi/@youTubeLink.Groups[1].Value/maxresdefault.jpg" class="img-fluid lazy">

      <div class="overlay d-flex justify-content-center align-items-center w-100 h-100" data-youtube="iframe-@CmsContext.Module.Id">
        <i class="fab fa-youtube"></i>
      </div>

      <iframe id="iframe-@CmsContext.Module.Id" data-youtube-src="@youTubeUrl" allowfullscreen></iframe>
    } else {
      <div class="dnnFormMessage dnnFormWarning">Video not found. Please check Video-Link.</div>
    }
  </div>
}
